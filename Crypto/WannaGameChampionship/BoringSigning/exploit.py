import socket
import struct
import sys
import time
from Crypto.Util.number import bytes_to_long, long_to_bytes, isPrime, inverse

BASE85_ALPHABET = b"!\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstu"
BASE85_INV = {c: i for i, c in enumerate(BASE85_ALPHABET)}

target = b"1_d4r3_y0u_70_519n_7h15_3x4c7_51x7y_f0ur_by73_57r1n9_w17h_my_k3y"

def decode_b85(s):
    res = bytearray()
    idx = 0
    while idx < len(s):
        chunk_len = min(5, len(s) - idx)
        chunk = s[idx : idx + chunk_len]
        idx += 5
        
        val = 0
        for c in chunk:
            val = val * 85 + BASE85_INV[c]
        if len(chunk) == 5:
            res.append((val >> 24) & 0xFF)
            res.append((val >> 16) & 0xFF)
            res.append((val >> 8) & 0xFF)
            res.append(val & 0xFF)
    return bytes(res)

def encode_b85(b):
    out = bytearray()
    i = 0
    while i < len(b):
        chunk = b[i:i+4]
        i += 4
        val = 0
        rem = len(chunk)
        if len(chunk) < 4:
            val = int.from_bytes(chunk, 'big')
            val <<= (8 * (4 - len(chunk)))
        else:
            val = int.from_bytes(chunk, 'big')
            
        # Convert to base85
        chars = []
        for _ in range(5):
            chars.append(BASE85_ALPHABET[val % 85])
            val //= 85
        chars.reverse()
        if rem == 4:
            out.extend(chars)
        else:
            out.extend(chars[:rem+1])
    return bytes(out)

HOST = 'challenge.cnsc.com.vn'
PORT = 31316

def exploit():
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((HOST, PORT))
        
        data = b""
        while b"\n" not in data:
            data += s.recv(1024)
        
        line = data.decode().strip()
        if "N = " not in line:
            print(f"Failed to find N in line: {line[:50]}...")
            return False
            
        parts = line.split("N = ")[1].split()
        if not parts:
            print("N value missing")
            return False
        b85_n = parts[0]
        
        try:
            N_bytes = decode_b85(b85_n.encode())
        except KeyError as e:
            print(f"KeyError in decode_b85. Invalid char: {e}")
            return False
        N = bytes_to_long(N_bytes)
        N_mutable = bytearray(N_bytes)
        
        found_prime = False
        good_char = 0
        good_N = 0
        
        for char_code in BASE85_ALPHABET:
            N_mutable[0] = char_code
            candidate_N = bytes_to_long(N_mutable)

            if isPrime(candidate_N):
                print(f"Found prime N' with char: {chr(char_code)} ({char_code})")
                good_char = char_code
                good_N = candidate_N
                found_prime = True
                break
        
        if not found_prime:
            print("No prime N' found in this session.")
            s.close()
            return False
            
        # Proceed with attack
        print("Sending Sign command to set N...")
        s.sendall(b"0\n")
        payload = b"!" * 79 + bytes([good_char])
        s.sendall(payload)
        s.sendall(b"\n")
        
        # Calculate forged signature
        # S = H(target)^d mod N'
        # d = e^-1 mod (N'-1)
        from Crypto.Hash import SHA256
        h = SHA256.new(target)
        h_val = bytes_to_long(h.digest())
        e = 0x10001
        d = inverse(e, good_N - 1)
        sig_val = pow(h_val, d, good_N)
        sig_bytes = long_to_bytes(sig_val, 384)
        sig_b85 = encode_b85(sig_bytes)
        print(f"Computed signature length: {len(sig_b85)}")
        
        # Send "1" (Verify)
        time.sleep(1) 
        s.sendall(b"1\n")
        
        # Send signature
        time.sleep(1)
        s.sendall(sig_b85)
        s.sendall(b"\n")
        
        # Read flag
        print("Waiting for response...")
        s.settimeout(5.0) # 5 seconds timeout
        try:
            res = b""
            while True:
                try:
                    chunk = s.recv(4096)
                    if not chunk: break
                    res += chunk
                    print(f"Got chunk: {chunk}")
                    if b"}" in chunk or b"Wrong" in chunk:
                        break
                except socket.timeout:
                    print("Socket timeout receiving response")
                    break
        except Exception as e:
            print(f"Recv error: {e}")
            
        res_str = res.decode('utf-8', errors='ignore')
        print("Result Repr:", repr(res_str))
        with open("flag.txt", "w") as f:
            f.write(res_str)
        
        s.close()
        return True

    except Exception as e:
        import traceback
        traceback.print_exc()
        return False

while True:
    print("Attempting exploit...")
    if exploit():
        break